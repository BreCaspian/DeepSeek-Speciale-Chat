<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DeepSeek - Speciale Chat</title>
  <style>
    :root {
      --bg-color: #050508;
      --input-bg: rgba(15, 15, 20, 0.35);
      --user-bubble: rgba(125, 249, 255, 0.14);
      --bot-bubble: rgba(15, 15, 20, 0.78);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      height: 100vh;
      background: radial-gradient(circle at 50% 120%, #1a2a3a 0%, #000000 70%);
      font-family: "Inter", -apple-system, sans-serif;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      color: #fff;
      transition: align-items 0.5s ease;
    }

    body.chat-started {
      align-items: stretch;
    }

    .sky-container {
      position: absolute;
      inset: 0;
      perspective: 1000px;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .stars-rotate {
      position: absolute;
      inset: -10vh;
      transform-origin: 50% 50%;
      animation: sky-rotate 240s linear infinite;
    }

    .star {
      position: absolute;
      border-radius: 50%;
      background: white;
      opacity: 0;
      animation: twinkle var(--dur) ease-in-out infinite;
      animation-delay: var(--del);
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.2; transform: scale(0.8); }
      50% { opacity: 0.9; transform: scale(1.2); box-shadow: 0 0 4px rgba(255, 255, 255, 0.8); }
    }

    @keyframes sky-rotate {
      from { transform: rotate(0deg) scale(1.05); }
      to   { transform: rotate(360deg) scale(1.05); }
    }

    .shooting-star {
      position: absolute;
      height: 1px;
      background: linear-gradient(90deg, transparent, white, transparent);
      animation: shoot 2s linear forwards;
      opacity: 0;
    }

    @keyframes shoot {
      0% { transform: translateX(0) translateY(0) rotate(-45deg) scaleX(0.5); opacity: 0; }
      10% { opacity: 1; transform: translateX(-20px) translateY(20px) rotate(-45deg) scaleX(1); }
      100% { transform: translateX(-300px) translateY(300px) rotate(-45deg) scaleX(1); opacity: 0; }
    }

    .ui-layer {
      position: relative;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      width: 100%;
      max-width: 900px;
      padding: 24px;
      transition: padding 0.5s ease, height 0.5s ease;
    }

    body.chat-started .ui-layer {
      height: 100vh;
      padding-top: 32px;
      padding-bottom: 16px;
    }

    .logo {
      font-size: 2.6rem;
      font-weight: 600;
      letter-spacing: -1px;
      margin-bottom: 2.4rem;
      text-shadow: 0 0 20px rgba(0,0,0,0.5);
      opacity: 0;
      animation: fadeIn 1.2s ease-out forwards;
      text-align: center;
    }

    .logo-main {
      color: #4b8dff;
      font-weight: 700;
    }

    .logo-sub {
      font-style: normal;
      font-weight: 400;
      color: #1f3fff;
      margin-left: 4px;
    }

    .chat-wrapper {
      width: 100%;
      margin-bottom: 0;
      max-height: 0;
      overflow-y: hidden;
      padding-right: 4px;
      display: none;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.4s ease, transform 0.4s ease, max-height 0.4s ease;
    }

    body.chat-started .chat-wrapper {
      display: block;
      flex: 1;
      opacity: 1;
      transform: translateY(0);
      max-height: none;
      overflow-y: auto;
      margin: 16px 0;
    }

    .chat-wrapper::-webkit-scrollbar {
      width: 6px;
    }
    .chat-wrapper::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.18);
      border-radius: 999px;
    }

    .msg-row {
      display: flex;
      margin-bottom: 12px;
    }

    .msg-row.user {
      justify-content: flex-end;
    }
    .msg-row.bot {
      justify-content: flex-start;
    }

    .msg-bubble {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position: relative;
    }

    .msg-row.user .msg-bubble {
      background: var(--user-bubble);
      border-bottom-right-radius: 4px;
    }

    .msg-row.bot .msg-bubble {
      background: var(--bot-bubble);
      border-bottom-left-radius: 4px;
    }

    .msg-bubble-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 10px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .msg-bubble-label {
      font-weight: 500;
    }

    .msg-bubble-toggle {
      border: none;
      background: transparent;
      color: inherit;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      font-size: 10px;
    }

    .msg-bubble-toggle::before {
      content: "▼";
      display: inline-block;
      transition: transform 0.2s ease;
    }

    .msg-bubble.collapsed .msg-bubble-toggle::before {
      transform: rotate(-90deg);
    }

    .msg-bubble-body {
      margin-top: 2px;
    }

    .msg-bubble.collapsed .msg-bubble-body {
      display: none;
    }

    .msg-main {
      white-space: pre-wrap;
      word-break: break-word;
    }

    .reasoning-box {
      margin-top: 8px;
      font-size: 12px;
      background: rgba(255,255,255,0.03);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.08);
      padding: 6px 10px 8px;
    }

    .reasoning-box summary {
      cursor: pointer;
      list-style: none;
      outline: none;
      user-select: none;
      font-weight: 500;
      color: rgba(200,220,255,0.9);
    }

    .reasoning-box summary::-webkit-details-marker {
      display: none;
    }

    .reasoning-box summary::after {
      content: "▶";
      font-size: 10px;
      margin-left: 6px;
      opacity: 0.8;
      transition: transform 0.2s ease;
    }

    .reasoning-box[open] summary::after {
      content: "▼";
    }

    .reasoning-content {
      margin-top: 4px;
      color: rgba(220, 230, 255, 0.9);
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.5;
    }

    .search-box {
      width: 100%;
      background: var(--input-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 24px;
      padding: 6px;
      display: flex;
      align-items: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      opacity: 0;
      animation: slideUp 1s ease-out 0.3s forwards;
      margin-top: 0;
    }

    body.chat-started .search-box {
      margin-top: 8px;
    }

    .search-box:focus-within {
      background: rgba(25, 25, 35, 0.6);
      border-color: rgba(125, 249, 255, 0.35);
      box-shadow: 0 15px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(125, 249, 255, 0.18);
      transform: scale(1.02);
    }

    .search-input {
      flex: 1;
      background: transparent;
      border: none;
      color: white;
      font-size: 16px;
      padding: 12px 16px;
      outline: none;
      font-weight: 300;
      resize: none;
      line-height: 1.5;
      max-height: 120px;
      overflow-y: auto;
    }

    .search-input::placeholder {
      color: rgba(220,220,230,0.55);
    }

    .search-input::-webkit-scrollbar {
      width: 4px;
    }
    .search-input::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 999px;
    }

    .search-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.12);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.2s;
      flex-shrink: 0;
    }

    .search-btn:hover {
      background: white;
      color: #000;
      transform: translateY(-1px) scale(1.05) rotate(6deg);
    }

    .search-btn:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
    }

    .model-hint {
      margin-top: 10px;
      font-size: 12px;
      font-style: italic;
      opacity: 0.7;
      text-align: center;
    }

    .dots {
      display: inline-block;
      min-width: 18px;
      text-align: left;
    }
    .dots::after {
      content: '...';
      animation: dots 1s steps(4, end) infinite;
    }
    @keyframes dots {
      0% { content: ''; }
      25% { content: '.'; }
      50% { content: '..'; }
      75% { content: '...'; }
      100% { content: ''; }
    }

    @keyframes fadeIn { to { opacity: 1; } }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js"></script>
</head>
<body>

  <div class="sky-container" id="sky">
    <div class="stars-rotate" id="starsRotate"></div>
  </div>

  <div class="ui-layer">
    <div class="logo">
      <span class="logo-main">DeepSeek</span>
      <span class="logo-sub">Speciale</span>
    </div>

    <div class="chat-wrapper" id="chatWrapper"></div>

    <div class="search-box">
      <textarea
        id="promptInput"
        class="search-input"
        rows="1"
        placeholder="Ask anything..."
      ></textarea>
      <button class="search-btn" id="sendBtn" title="Send">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>

    <div class="model-hint">DeepSeek-V3.2-Speciale</div>
  </div>

  <script>
    function renderMarkdownToElement(el, text) {
      if (!text) {
        el.textContent = "";
        return;
      }
      const html = marked.parse(text);
      const safeHtml = DOMPurify.sanitize(html);
      el.innerHTML = safeHtml;
      if (window.renderMathInElement) {
        renderMathInElement(el, {
          delimiters: [
            { left: "$$", right: "$$", display: true },
            { left: "$", right: "$", display: false },
            { left: "\\(", right: "\\)", display: false },
            { left: "\\[", right: "\\]", display: true }
          ]
        });
      }
    }

    const starsRotate = document.getElementById('starsRotate');
    const bgStarCount = 150;

    function initSky() {
      for (let i = 0; i < bgStarCount; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        const s = Math.random() * 2 + 1;
        star.style.width = s + 'px';
        star.style.height = s + 'px';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.setProperty('--dur', (Math.random() * 3 + 2) + 's');
        star.style.setProperty('--del', (Math.random() * 5) + 's');
        starsRotate.appendChild(star);
      }
    }

    function spawnShootingStar() {
      const sky = document.getElementById('sky');
      const star = document.createElement('div');
      star.className = 'shooting-star';
      star.style.top = (Math.random() * 50) + '%';
      star.style.left = (Math.random() * 50 + 50) + '%';
      star.style.width = (Math.random() * 100 + 50) + 'px';
      sky.appendChild(star);
      setTimeout(() => star.remove(), 2500);
      setTimeout(spawnShootingStar, Math.random() * 4000 + 2000);
    }

    const API_URL = "https://deepseek-speciale-chat.vercel.app/api/chat";

    const chatWrapper = document.getElementById('chatWrapper');
    const inputEl = document.getElementById('promptInput');
    const sendBtn = document.getElementById('sendBtn');

    const history = [];

    let chatStarted = false;
    function ensureChatLayoutStarted() {
      if (chatStarted) return;
      chatStarted = true;
      document.body.classList.add('chat-started');
    }

    function createReasoningBox(text) {
      const details = document.createElement('details');
      details.className = 'reasoning-box';

      const summary = document.createElement('summary');
      summary.textContent = 'Reasoning';
      details.appendChild(summary);

      const content = document.createElement('div');
      content.className = 'reasoning-content';
      content.textContent = text;
      details.appendChild(content);

      return details;
    }

    function appendMessage(role, text, options = {}) {
      const { isThinking = false, reasoning = null } = options;

      const row = document.createElement('div');
      row.className = `msg-row ${role}`;

      const bubble = document.createElement('div');
      bubble.className = 'msg-bubble';

      const header = document.createElement('div');
      header.className = 'msg-bubble-header';

      const label = document.createElement('span');
      label.className = 'msg-bubble-label';
      label.textContent = role === 'bot' ? 'DeepSeek-V3.2-Speciale' : 'You';
      header.appendChild(label);

      const toggleBtn = document.createElement('button');
      toggleBtn.type = 'button';
      toggleBtn.className = 'msg-bubble-toggle';
      header.appendChild(toggleBtn);

      bubble.appendChild(header);

      const body = document.createElement('div');
      body.className = 'msg-bubble-body';

      const main = document.createElement('div');
      main.className = 'msg-main';

      if (isThinking) {
        const span = document.createElement('span');
        span.className = 'dots';
        main.appendChild(span);
      } else {
        renderMarkdownToElement(main, text);
      }

      body.appendChild(main);

      if (reasoning) {
        const rb = createReasoningBox(reasoning);
        body.appendChild(rb);
      }

      bubble.appendChild(body);
      row.appendChild(bubble);
      chatWrapper.appendChild(row);

      toggleBtn.addEventListener('click', () => {
        bubble.classList.toggle('collapsed');
      });

      chatWrapper.scrollTop = chatWrapper.scrollHeight;

      return { row, bubble, body, main };
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;
      inputEl.value = '';
      autoResizeTextarea();

      ensureChatLayoutStarted();

      history.push({ role: "user", content: text });

      appendMessage('user', text);
      const thinking = appendMessage('bot', '', { isThinking: true });

      sendBtn.disabled = true;

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: text,
            history
          })
        });

        let data = null;
        try {
          data = await res.json();
        } catch (e) {
          data = null;
        }

        if (!res.ok) {
          const msg =
            (data && data.error) ||
            (data && data.detail && JSON.stringify(data.detail)) ||
            `HTTP ${res.status}`;
          throw new Error(msg);
        }

        const reply = (data && (data.reply || data.content)) || "（无返回内容）";
        const reasoning = data && data.reasoning ? data.reasoning : null;

        renderMarkdownToElement(thinking.main, reply);

        history.push({ role: "assistant", content: reply });

        if (reasoning) {
          const rb = createReasoningBox(reasoning);
          thinking.body.appendChild(rb);
        }
      } catch (err) {
        const msg = typeof err.message === "string" ? err.message : String(err);
        thinking.main.textContent = "请求出错了：" + msg;
        console.error(err);
      } finally {
        sendBtn.disabled = false;
        chatWrapper.scrollTop = chatWrapper.scrollHeight;
      }
    }

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        if (!e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    function autoResizeTextarea() {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
    }
    inputEl.addEventListener('input', autoResizeTextarea);

    initSky();
    spawnShootingStar();
  </script>
</body>
</html>

